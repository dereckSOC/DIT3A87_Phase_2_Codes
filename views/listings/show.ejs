<%- include("../partials/header") %>

  <h1>This is the listings page</h1>

  <div id='map'></div>

  <div>
    <h4>
      <%= listing.name %>
    </h4>
    <img src="<%= listing.image %>">
    <p>
      <%= listing.description %>
    </p>
  </div>
  <div>
    <p>
      <%= listing.price %>
    </p>
  </div>
  <p>
    <em>Submitted by: <%= listing.author.username %>, <%= moment(listing.createdAt).fromNow() %></em>
  </p>
  <% if(currentUser && listing.author.id.equals(currentUser._id) || currentUser && currentUser.isAdmin){ %>
    <a class="btn btn-warning" href="/listings/<%= listing._id %>/edit">Edit</a>
    <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST">
      <button class="btn btn-danger">DELETE</button>
    </form>
    <% } %>

      <% listing.comments.forEach(function(comment){ %>
        <p>
          <strong>
            <%= comment.author.username %>
          </strong> - <%= comment.text %>
        </p>
        <% if(currentUser && comment.author.id.equals(currentUser._id) || currentUser && currentUser.isAdmin){ %>
          <a class="btn btn-warning" href="/listings/<%= listing._id %>/comments/<%= comment._id %>/edit">Edit</a>
          <form action="/listings/<%= listing._id %>/comments/<%= comment._id %>?_method=DELETE" method="POST">
            <button class="btn btn-danger">DELETE</button>
          </form>
          <% } %>
            <% }) %>

              <div class="pull-right">
                <button type="button" class="btn btn-xs btn-primary" data-toggle="modal" data-target="#listingLikes">
                  <span>Total likes: <i class="fas fa-thumbs-up"></i>
                    <%= listing.likes.length %>
                  </span>
                </button>
              </div>
              <div style="padding-bottom: 10px;">
                <form action="/listings/<%= listing._id %>/like" method="POST">
                  <div class="btn-group">
                    <% if (currentUser && listing.likes.some(function (like) { return like.equals(currentUser._id) })) {
                      %>
                      <button class="btn btn-sm btn-primary">
                        <i class="fas fa-thumbs-up"></i> Liked (<%= listing.likes.length %>)
                      </button>
                      <% } else { %>
                        <button class="btn btn-sm btn-secondary">
                          <i class="fas fa-thumbs-up"></i> Like (<%= listing.likes.length %>)
                        </button>
                        <% } %>
                          <button type="button" class="btn btn-sm btn-default" data-toggle="modal"
                            data-target="#listingLikes">See more details
                          </button>
                  </div>
                </form>
              </div>

              <div id="listingLikes" class="modal fade" role="dialog">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <button type="button" class="close" data-dismiss="modal">&times;</button>
                      <h4 class="modal-title">listing likes: <%= listing.likes.length %>
                      </h4>
                    </div>
                    <div class="modal-body">
                      <table class="table table-striped">
                        <thead>
                          <tr>
                            <th>Liked by:</th>
                          </tr>
                        </thead>
                        <tbody>
                          <% listing.likes.forEach(function(like) { %>
                            <tr>
                              <td><span class="badge"><i class="fas fa-user"></i></span>
                                <%= like.username %>
                              </td>
                            </tr>
                            <% }); %>
                              <% if (listing.likes.length===0) { %>
                                <tr>
                                  <td><em>No likes yet.</em></td>
                                </tr>
                                <% } %>
                        </tbody>
                      </table>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                  </div>
                </div>
              </div>

              <p>
                <a class="btn btn-success" href="/listings/<%= listing._id %>/comments/new">Add new Comment</a>
              </p>

              <script>
                const mapToken = '<%- process.env.MAPBOX_TOKEN %>'
                const listing = <%- JSON.stringify(listing) %>
              </script>
              <script src="/javascripts/showPageMap.js"></script>

              <%- include("../partials/footer") %>