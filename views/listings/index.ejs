<%- include("../partials/header") %>

  <% if(currentUser && currentUser.isAdmin){ %>
    <h1>You're an admin!</h1>
    <% } else if (currentUser && currentUser.isAgent && currentUser.agentStatus){ %>
      <h1>You're an agent!</h1>
      <% } %>

        <!-- No Match -->
        <div class="container">
          <% if(noMatch !==undefined){ %>
            <form action="/listings" method="GET" class="form-inline">
              <div class="form-group">
                <input type="text" class="form-control" name="search" placeholder="listing search...">
                <input type="submit" value="Search" class="btn btn-info">
              </div>
            </form>

            <h3>
              <%= noMatch %>
            </h3>
            <% } %>

              <% if(currentUser && currentUser.isAdmin || currentUser && currentUser.isAgent &&
                currentUser.agentStatus){ %>
                <a href="/listings/new">Add New listing</a>
                <% } %>

                  <div id="map" style="width: 70%; height: 500px;"></div>

                  <h1>This is the listings page</h1>
                  <% listings.forEach(function(listing){ %>
                    <div>
                      <h4>
                        <%= listing.name %>
                      </h4>
                      <img src="<%= listing.image %>">
                      <div>
                        <span class="badge label-primary"><i class="fas fa-thumbs-up"></i>
                          <%= listing.likes.length %>
                        </span>
                        <span>
                          <%= moment(listing.createdAt).format('LLLL'); %>
                        </span>
                      </div>
                    </div>
                    <a href="/listings/<%= listing._id %>">More Info</a>
                    <% }); %>

                      <nav aria-label="Page navigation">
                        <% if (pages && pages> 0) { %>
                          <ul class="pagination justify-content-center">
                            <% if (current==1) { %>
                              <li class="page-item disabled"><a class="page-link">First</a></li>
                              <% } else { %>
                                <li><a class="page-link"
                                    href="/listings<%if(search){%>?search=<%=search%><%}%>">First</a></li>
                                <% } %>

                                  <% if (current==1) { %>
                                    <li class="page-item disabled"><a class="page-link">«</a></li>
                                    <% } else { %>
                                      <li><a class="page-link"
                                          href="/listings?page=<%= Number(current) - 1 %><%if(search){%>&search=<%=search%><%}%>">«</a>
                                      </li>
                                      <% } %>

                                        <% var i=(Number(current)> 5 ? Number(current) - 4 : 1) %>
                                          <% if (i !==1) { %>
                                            <li class="page-item disabled"><a class="page-link">...</a></li>
                                            <% } %>
                                              <% for (; i <=(Number(current) + 4) && i <=pages; i++) { %>
                                                <% if (i==current) { %>
                                                  <li class="active"><a class="page-link">
                                                      <%= i %>
                                                    </a></li>
                                                  <% } else { %>
                                                    <li><a class="page-link"
                                                        href="/listings?page=<%= i %><%if(search){%>&search=<%=search%><%}%>">
                                                        <%= i %>
                                                      </a></li>
                                                    <% } %>
                                                      <% if (i==Number(current) + 4 && i < pages) { %>
                                                        <li class="page-item disabled"><a class="page-link">...</a></li>
                                                        <% } %>
                                                          <% } %>

                                                            <% if (current==pages) { %>
                                                              <li class="page-item disabled"><a class="page-link">»</a>
                                                              </li>
                                                              <% } else { %>
                                                                <li><a class="page-link"
                                                                    href="/listings?page=<%= Number(current) + 1 %><%if(search){%>&search=<%=search%><%}%>">»</a>
                                                                </li>
                                                                <% } %>

                                                                  <% if (current==pages) { %>
                                                                    <li class="page-item disabled"><a
                                                                        class="page-link">Last</a></li>
                                                                    <% } else { %>
                                                                      <li><a class="page-link"
                                                                          href="/listings?page=<%= pages %><%if(search){%>&search=<%=search%><%}%>">Last</a>
                                                                      </li>
                                                                      <% } %>
                          </ul>
                          <% } %>
                      </nav>


        </div>


        <script>
          const mapToken = '<%- process.env.MAPBOX_TOKEN %>'
          const listings = { features: <%- JSON.stringify(listings) %> }
        </script>
        <script src="/javascripts/clusterMap.js"></script>

        <%- include("../partials/footer") %>